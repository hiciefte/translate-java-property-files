# Repository Structure

This document outlines the structure and purpose of the files and directories within this project.

## Root Directory

- **`.git/`**: Contains Git version control information.
- **`.github/`**: Contains GitHub-specific files like workflows or issue templates.
  - **`workflows/`**: Contains GitHub Actions workflow files.
    - **`build-verify.yml`**: Defines a CI workflow that runs on pull requests. It lints the Dockerfile, scans dependencies and the final image for vulnerabilities, and verifies that the Docker image can be built successfully.
- **`docker/`**: Contains all files for building and running the Dockerized application.
  - **`Dockerfile`**: Defines the Docker image, installs dependencies (Python, Git, GPG, CLIs), sets up `appuser`, and imports the bot GPG key.
  - **`docker-compose.yml`**: Configures the Docker service (`translator`), manages environment variables (from `docker/.env` by default), and volume mounts.
  - **`config.docker.yaml`**: Configuration file used *inside* the Docker container (mounted as `/app/config.yaml` by `docker-compose.yml`).
  - **`translator-cron`**: Crontab file defining the scheduled execution of `update-translations.sh` via the entrypoint.
  - **`docker-entrypoint.sh`**: Script run on container start; manages repository cloning/updating, GPG/user environment setup, and starts cron.
  - **`.env.example`**: Example environment variable file. The user must copy this to `docker/.env` and customize it.
- **`docs/`**: Contains project documentation.
  - **`repository-structure.md`**: This file.
  - **`docker/.env.example`**: Example environment variable file. The user must copy this to `docker/.env` and customize it.
- **`logs/`**: (Created by the application, should be in `.gitignore`) Stores runtime logs from cron, `update-translations.sh`, and `translate_localization_files.py`.
- **`secrets/`**: (Must be in `.gitignore`) Stores sensitive files.
  - **`gpg_bot_key/`**: Contains the bot's GPG public (`bot_public_key.asc`) and secret (`bot_secret_key.asc`) keys, copied into the Docker image.
- **`src/`**: Contains the main Python source code for the translation utilities.
- **`tests/`**: (If present) Contains test files for the project.
- **`venv/`**: (If used for local development) Contains Python virtual environment files.
- **`.DS_Store`**: macOS specific file storing custom attributes of its containing folder (should be in `.gitignore`).
- **`.gitignore`**: Specifies intentionally untracked files that Git should ignore.
- **`.hadolint.yaml`**: Configuration file for the `hadolint` Dockerfile linter. Used to specify rules to ignore, such as pinning base image versions.
- **`.trivyignore`**: Configuration file for the `Trivy` vulnerability scanner. Used to suppress specific CVEs that are deemed false positives or are not actionable.
- **`CONTRIBUTING.md`**: (If present) Guidelines for contributing to the project.
- **`LICENSE`**: Project's license file.
- **`README.md`**: Provides the primary overview, setup, configuration, and usage instructions for the project, especially for the Dockerized service.
- **`SECURITY_STRATEGY.md`**: (If maintained) Outlines the security strategy for the project.
- **`Translate Java Property Files.iml`**: (If using IntelliJ) IntelliJ IDEA module file.
- **`config.yaml`**: Configuration file for **manual/local runs** of the translation scripts (not used by the Docker service directly unless specifically mounted).
- **`config.example.yaml`**: Example for `config.yaml`.
- **`glossary.json`**: Contains a glossary of terms for translation, used by `src/translate_localization_files.py`.
- **`requirements.txt`**: Lists the Python dependencies for the project.
- **`update-translations.sh`**: Main orchestration shell script, run by cron inside the Docker container to perform the end-to-end translation workflow.

## `src/` Directory

- **`__pycache__/`**: (Should be in `.gitignore`) Contains bytecode cache files generated by Python.
- **`translate_localization_files.py`**: The main Python script responsible for handling the translation of localization files.

## `tests/` Directory

- **`.pytest_cache/`**: (Should be in `.gitignore`) Cache directory for pytest specific to tests.
- **`__pycache__/`**: (Should be in `.gitignore`) Contains bytecode cache files generated by Python for test modules.
- **`__init__.py`**: Makes the `tests` directory a Python package.
- **`.DS_Store`**: (Should be in `.gitignore`) macOS specific file.

## Key Files Overview

- **`docker/Dockerfile`**: Defines the Docker image. It sets up an Ubuntu environment, installs Python, Git, GnuPG, Transifex CLI, GitHub CLI, and cron. It creates an `appuser` (with UID/GID from build arguments passed from `docker/.env` via `docker-compose.yml`) and imports a dedicated bot GPG key from the `secrets/gpg_bot_key/` directory in the build context.

- **`docker/docker-compose.yml`**: Configures and runs the `translator` service. It passes build arguments (like `HOST_UID`, `HOST_GID`) and runtime environment variables (API keys, Git repository URLs, GPG signing details) from the `docker/.env` file (located in the same directory as the `docker-compose.yml`). It also manages volume mounts for the Docker-specific configuration (`docker/config.docker.yaml` to `/app/config.yaml`), the glossary (`glossary.json` to `/app/glossary.json`), persistent logs (`./logs` to `/app/logs`), and the host's SSH keys (`~/.ssh` to `/home/appuser/.ssh` for Git push operations).

- **`docker/config.docker.yaml`**: This is the **primary configuration file used by the automated Docker service**. It is mounted into the container at `/app/config.yaml` by `docker-compose.yml`. It defines paths relative to the container's filesystem (e.g., `target_project_root: /target_repo`), the OpenAI model, paths for translation queue folders (which are created in `appuser`'s home directory inside the container, e.g., `/home/appuser/.translation_queue`), and other operational parameters for `src/translate_localization_files.py`.

- **`docker/docker-entrypoint.sh`**: This script is the `ENTRYPOINT` for the Docker container.
    - When run as `root` (on initial container start): It clones the `FORK_REPO_URL` into `/target_repo` (if it doesn't exist) or updates it, sets up the `upstream` remote, and critically changes the fork's `origin` remote URL to the SSH format (e.g., `git@github.com:owner/repo.git`) to enable SSH key-based pushes. It then performs `chown` on `/target_repo` to grant `appuser` ownership, prepares `XDG_RUNTIME_DIR` for `appuser`, and starts the `cron` daemon (checking if it's already running).
    - When run as `appuser` (e.g., by the cron job, or manually for executing a command like `update-translations.sh`): It sets up `XDG_RUNTIME_DIR` for GPG, `GPG_TTY`, ensures the `gpg-agent` is running correctly (including killing old processes and removing stale sockets/locks), configures Git `user.name`, `user.email`, and `user.signingkey` from environment variables, and then executes the command passed to it (typically `/app/update-translations.sh`).

- **`docker/translator-cron`**: A simple crontab file that defines the schedule (e.g., daily) for running the `/app/update-translations.sh` script. The cron job invokes this script via `/app/docker/docker-entrypoint.sh` to ensure the `appuser` environment is correctly set up.

- **`src/translate_localization_files.py`**: This is the core Python script that orchestrates the translation process. Its main responsibilities include:
    - Loading configuration from `/app/config.yaml` (which is the mounted `docker/config.docker.yaml`) and `glossary.json`.
    - Parsing Java `.properties` files from the `input_folder` within the `/target_repo`.
    - Identifying text segments that need translation.
    - Interacting with the OpenAI API for translations.
    - Managing a file-based queue system (e.g., in `/home/appuser/.translation_queue`) for processing files.
    - Writing translated files back to the `input_folder` in `/target_repo`.
    - Logging its activities to `/app/logs/translation_log.log`.

- **`update-translations.sh`**: This shell script, located in the project root and copied to `/app/` in the Docker image, automates the end-to-end translation update process when run inside the container as `appuser`. It performs the following:
    - Sets up a Python virtual environment in `appuser`'s home and installs dependencies from `/app/requirements.txt`.
    - Loads `TX_TOKEN` (Transifex API token) from the environment.
    - Reads configuration (e.g., `target_project_root`) from `/app/config.yaml`.
    - Navigates to the `target_project_root` (i.e., `/target_repo`).
    - Manages Git operations: stashes local changes, ensures it's on the `main` branch (which should have been reset to `upstream/main` by the entrypoint).
    - Pulls the latest translations from Transifex using `tx pull -t`.
    - Runs the `src/translate_localization_files.py` script (using Python from the venv).
    - Cleans up archived files created by the Python script.
    - If translation changes are detected, it creates a new Git branch, adds and commits the changes (GPG signed).
    - Pushes the new branch to the fork on GitHub (origin).
    - Attempts to create a GitHub pull request using `gh pr create` from the new branch on the fork to the configured base branch on the upstream repository.
    - **Conditionally pushes** updated source translations to Transifex using `tx push -t` **only if the GitHub PR creation was successful.**
    - Returns to the original Git branch (`main`).

- **`config.yaml` (at the project root)**: This configuration file is intended for **manual or local development runs** of the translation scripts *outside* of the Docker container. It is not directly used by the default Dockerized service, which uses `docker/config.docker.yaml`.

- **`deploy.sh`**: (This script's role needs re-evaluation. It appears to be for an alternative, non-Docker server setup or an earlier version of deployment automation. The primary server deployment documented in `README.md` relies on Docker Compose and systemd.) If this script is outdated or deprecated, its mention here should reflect that or be removed. The note about its `ExecStart` pointing to itself causing a loop is important if it's ever considered for use.

- **`glossary.json`**: A JSON file in the project root, mounted into `/app/glossary.json` in Docker. It stores language-specific glossaries used by `src/translate_localization_files.py` to ensure consistent translation of key terms.

- **`requirements.txt`**: Lists the Python dependencies (e.g., `openai`, `PyYAML`, `tiktoken`) needed for `src/translate_localization_files.py`. Installed into a virtual environment by `update-translations.sh`.

- **`README.md`**: Provides the most current and comprehensive overview of the project, including prerequisites, setup instructions for Docker, configuration of `.env` and GPG/SSH keys, Docker usage, server deployment with systemd, manual usage, and the overall workflow. It should be considered the primary source of truth for setting up and running the service. 
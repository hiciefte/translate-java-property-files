# Repository Structure

This document outlines the structure and purpose of the files and directories within this project.

## Root Directory

- **`.git/`**: Contains Git version control information.
- **`.idea/`**: Contains IntelliJ IDEA project-specific settings.
- **`.pytest_cache/`**: Cache directory for pytest.
- **`docs/`**: Contains project documentation.
  - **`repository-structure.md`**: This file.
- **`src/`**: Contains the main source code for the translation utilities.
- **`tests/`**: Contains test files for the project.
- **`translation_queue/`**: (Assumed based on `config.yaml`) Folder for files awaiting translation.
- **`translated_queue/`**: (Assumed based on `config.yaml`) Folder for files that have been translated.
- **`venv/`**: Contains the Python virtual environment files.
- **`.DS_Store`**: macOS specific file storing custom attributes of its containing folder.
- **`.gitignore`**: Specifies intentionally untracked files that Git should ignore.
- **`AUTOMATED_SETUP.md`**: Documentation for automating the setup of the project.
- **`CONTRIBUTING.md`**: Guidelines for contributing to the project.
- **`LICENSE`**: Project's license file.
- **`README.md`**: Provides an overview of the project, setup instructions, and usage.
- **`SECURITY_STRATEGY.md`**: Outlines the security strategy for the project.
- **`TRANSIFEX_SETUP.md`**: Documentation related to Transifex setup.
- **`Translate Java Property Files.iml`**: IntelliJ IDEA module file.
- **`config.example.yaml`**: Example configuration file.
- **`config.yaml`**: Main configuration file for the project.
- **`deploy.sh`**: Script for deploying the project or its outputs.
- **`glossary.json`**: Contains a glossary of terms for translation.
- **`requirements.txt`**: Lists the Python dependencies for the project.
- **`translation_log.log`**: Log file for translation activities.
- **`update-translations.sh`**: Script for updating translations.

## `src/` Directory

- **`__pycache__/`**: Contains bytecode cache files generated by Python.
- **`translate_localization_files.py`**: The main Python script responsible for handling the translation of localization files.
- **`translation_log.log`**: (Likely a duplicate or specific log for this module, but one exists at root too) Log file for translation activities within the src module.

## `tests/` Directory

- **`.pytest_cache/`**: Cache directory for pytest specific to tests.
- **`__pycache__/`**: Contains bytecode cache files generated by Python for test modules.
- **`__init__.py`**: Makes the `tests` directory a Python package.
- **`.DS_Store`**: macOS specific file.
- **`translation_log.log`**: (Likely a duplicate or specific log for this module) Log file for translation activities within the tests module.

## Key Files Overview

- **`config.yaml`**: The main configuration file for the project. It defines paths (target project root, input folder for `.properties` files, glossary file), the OpenAI model to use, folders for the translation queue system (`translation_queue`, `translated_queue`), a `dry_run` flag for testing, and a list of `supported_locales` with their codes and names.

- **`src/translate_localization_files.py`**: This is the core Python script that orchestrates the translation process. Its main responsibilities include:
    - Loading configuration and glossary.
    - Parsing Java `.properties` files.
    - Identifying text segments that need translation by comparing with a source (English) version.
    - Interacting with the OpenAI API (asynchronously with rate limiting and retries) to translate texts, applying context from existing translations and the glossary.
    - Handling placeholders (like `{0}` or HTML tags) to ensure they are not translated.
    - Reassembling translated files.
    - Managing a file-based queue system:
        - Detecting changed translation files in the `input_folder` (specified in `config.yaml`) using `git status`.
        - Copying these changed files to the `TRANSLATION_QUEUE_FOLDER`.
        - Processing files from the queue, saving translated versions to `TRANSLATED_QUEUE_FOLDER`.
        - Copying translated files back to the `input_folder`.
        - Archiving original files from the queue.
        - Cleaning up queue folders.
    - Logging activities to `translation_log.log`.

- **`update-translations.sh`**: This shell script automates the end-to-end translation update process. It performs the following:
    - Sets up a Python virtual environment and installs dependencies from `requirements.txt`.
    - Loads `TX_TOKEN` (Transifex API token) from an environment file.
    - Reads `config.yaml` to get `target_project_root` and `input_folder`.
    - Navigates to the `target_project_root` of the Java project being translated.
    - Manages Git operations: stashes local changes, checks out `main`, pulls latest, updates submodules.
    - Pulls the latest translations from Transifex using the `tx pull -t` command.
    - Navigates back and runs the `src/translate_localization_files.py` script.
    - Cleans up archived files created by the Python script.
    - Commits any new translations (specifically `.properties` files in `i18n/src/main/resources/` within the target project) to a new Git branch.
    - Pushes the branch to GitHub and attempts to create a pull request using `gh`.
    - Pushes updated source files (potentially with new keys from development) back to Transifex using `tx push -t`.
    - Restores the original Git branch and any stashed changes.

- **`deploy.sh`**: This script is designed to set up a server environment (intended to be run as root) to automate the execution of the translation updates. Its tasks include:
    - System package updates and installation of essential tools (Python, Git, GPG, GitHub CLI, Transifex CLI).
    - Creation of a dedicated user (`bisquser`) and workspace.
    - Instructions for manual SSH/GPG key setup and repository cloning for `bisquser`.
    - Setting up the Python virtual environment for the project.
    - Creation of systemd service (`translation-service.service`) and timer (`translation-service.timer`) files. The timer is configured to run daily.
        - **Note**: The service's `ExecStart` currently points to `deploy.sh` itself, which would cause a loop. It should likely point to `update-translations.sh`.
    - Creation of an environment file template (`/home/bisquser/.env`) for API keys.
    - Enabling and starting the systemd timer.

- **`glossary.json`**: A JSON file storing language-specific glossaries. For each language code (e.g., "de"), it contains a dictionary of terms and their required translations to ensure consistency (e.g., `"Bitcoin": "Bitcoin"`).

- **`requirements.txt`**: Lists the Python dependencies needed for the project, such as `openai`, `PyYAML`, `tiktoken`, `aiolimiter`, and testing libraries.

- **`README.md`**: Provides a comprehensive overview of the project, including prerequisites, setup instructions, configuration details, usage of the main Python script, and information about the glossary and testing. 